<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Agent - AI Agent Cost Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --surface: #12121a; --surface-2: #1a1a26; --border: #2a2a3a;
  --text: #e4e4ef; --text-dim: #8888a0; --accent: #00ff88; --accent-dim: #00cc6a;
  --danger: #ff4466; --danger-dim: #cc3355; --warning: #ffaa22; --info: #44aaff; --purple: #aa66ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
.header { display: flex; align-items: center; justify-content: space-between; padding: 20px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
.header h1 { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; color: var(--accent); letter-spacing: -0.5px; }
.header h1 span { color: var(--text-dim); font-weight: 400; }
.header-badge { font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 4px 12px; border-radius: 20px; background: rgba(0,255,136,0.1); color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
.main { display: grid; grid-template-columns: 1fr 400px; grid-template-rows: auto auto 1fr; gap: 0; height: calc(100vh - 65px); }
.stats-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
.stat-card { background: var(--surface); padding: 20px 24px; display: flex; flex-direction: column; gap: 6px; }
.stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.stat-value { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; color: var(--text); }
.stat-value.danger { color: var(--danger); } .stat-value.accent { color: var(--accent); } .stat-value.warning { color: var(--warning); }
.stat-sub { font-size: 12px; color: var(--text-dim); }
.dashboard { grid-column: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
.panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; flex-shrink: 0; }
.panel-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
.panel-title { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text); }
.panel-body { padding: 20px; }
.cost-bar-group { display: flex; flex-direction: column; gap: 14px; }
.cost-bar-item { display: grid; grid-template-columns: 160px 1fr 80px; align-items: center; gap: 12px; }
.cost-bar-label { font-size: 13px; color: var(--text); font-weight: 500; }
.cost-bar-track { height: 24px; background: var(--surface-2); border-radius: 4px; overflow: hidden; position: relative; }
.cost-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; position: relative; }
.cost-bar-fill.waste { background: linear-gradient(90deg, var(--danger), var(--danger-dim)); }
.cost-bar-fill.useful { background: linear-gradient(90deg, var(--accent), var(--accent-dim)); }
.cost-bar-fill.warning { background: linear-gradient(90deg, var(--warning), #cc8800); }
.cost-bar-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-align: right; }
.agent-table { width: 100%; border-collapse: collapse; }
.agent-table th { text-align: left; font-family: 'JetBrains Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); padding: 8px 12px; border-bottom: 1px solid var(--border); }
.agent-table td { padding: 12px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.03); }
.agent-table td.mono { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
.model-badge { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--surface-2); color: var(--purple); border: 1px solid rgba(170,102,255,0.2); }
.rec-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--danger); }
.rec-card:last-child { margin-bottom: 0; }
.rec-issue { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: var(--danger); }
.rec-fix { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 8px; }
.rec-savings { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); font-weight: 600; }
.chat-panel { grid-column: 2; grid-row: 2 / -1; border-left: 1px solid var(--border); display: flex; flex-direction: column; background: var(--surface); }
.chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
.chat-header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.msg { max-width: 95%; padding: 12px 16px; border-radius: 8px; font-size: 13px; line-height: 1.6; }
.msg.assistant { background: var(--surface-2); border: 1px solid var(--border); align-self: flex-start; }
.msg.user { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.2); align-self: flex-end; color: var(--accent); }
.msg.system { background: transparent; color: var(--text-dim); font-size: 12px; text-align: center; align-self: center; font-style: italic; }
.chat-input-area { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
.chat-input { flex: 1; background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 13px; outline: none; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-dim); }
.chat-send { background: var(--accent); border: none; border-radius: 6px; padding: 10px 16px; color: var(--bg); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; font-family: 'JetBrains Mono', monospace; }
.chat-send:hover { background: var(--accent-dim); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
.quick-actions { padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 6px; border-bottom: 1px solid var(--border); }
.quick-btn { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 5px 10px; border-radius: 4px; background: var(--surface-2); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
.quick-btn:hover { border-color: var(--accent); color: var(--accent); }
.timeline-row { display: grid; grid-template-columns: 80px 1fr 60px; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 12px; }
.timeline-time { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 11px; }
.timeline-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.timeline-dot.heartbeat { background: var(--danger); } .timeline-dot.memory_resync { background: var(--warning); }
.timeline-dot.user_request { background: var(--accent); } .timeline-dot.response { background: var(--info); }
.timeline-dot.compaction { background: var(--purple); } .timeline-dot.other { background: var(--text-dim); }
.timeline-cost { font-family: 'JetBrains Mono', monospace; text-align: right; font-size: 11px; color: var(--text-dim); }
.loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-dim); font-size: 13px; }
.spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
@keyframes spin { to { transform: rotate(360deg); } }
::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
@media (max-width: 900px) { .main { grid-template-columns: 1fr; } .chat-panel { grid-column: 1; grid-row: auto; height: 400px; } .stats-row { grid-template-columns: repeat(2, 1fr); } }
</style>
</head>
<body>
<div class="header">
  <h1>Budget Agent <span>/ clawdbot</span></h1>
  <div class="header-badge">Strands + Bedrock + Datadog</div>
</div>
<div class="main">
  <div class="stats-row">
    <div class="stat-card"><div class="stat-label">Total Spent</div><div class="stat-value" id="total-cost">--</div><div class="stat-sub">across all agents</div></div>
    <div class="stat-card"><div class="stat-label">Hidden Costs</div><div class="stat-value danger" id="hidden-cost">--</div><div class="stat-sub" id="waste-pct">-- of total</div></div>
    <div class="stat-card"><div class="stat-label">Monthly Projection</div><div class="stat-value warning" id="monthly-cost">--</div><div class="stat-sub">at current rate</div></div>
    <div class="stat-card"><div class="stat-label">Potential Savings</div><div class="stat-value accent" id="savings">--</div><div class="stat-sub">per month with fixes</div></div>
  </div>
  <div class="dashboard">
    <div class="panel"><div class="panel-header"><div class="panel-title">Hidden Cost Breakdown</div></div><div class="panel-body"><div class="cost-bar-group" id="cost-bars"><div class="loading"><div class="spinner"></div>Analyzing costs...</div></div></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">Active Agents</div></div><div class="panel-body" style="padding:0"><table class="agent-table" id="agent-table"><thead><tr><th>Agent</th><th>Model</th><th>Tokens</th><th>Sessions</th><th>Cost</th></tr></thead><tbody id="agent-tbody"><tr><td colspan="5"><div class="loading"><div class="spinner"></div>Loading agents...</div></td></tr></tbody></table></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">Optimization Recommendations</div></div><div class="panel-body" id="recommendations"><div class="loading"><div class="spinner"></div>Generating recommendations...</div></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">Cost Timeline</div></div><div class="panel-body" id="timeline"><div class="loading"><div class="spinner"></div>Loading timeline...</div></div></div>
  </div>
  <div class="chat-panel">
    <div class="chat-header"><div class="dot"></div>Ask the Auditor</div>
    <div class="quick-actions">
      <button class="quick-btn" onclick="sendMessage('Show me my hidden costs')">Hidden costs</button>
      <button class="quick-btn" onclick="sendMessage('How much would it cost to research competitors?')">Estimate task</button>
      <button class="quick-btn" onclick="sendMessage('Which agent wastes the most?')">Worst agent</button>
      <button class="quick-btn" onclick="sendMessage('How can I save money?')">Save money</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="msg system">Budget Agent connected. Ask me anything about your AI spending.</div>
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chat-input" placeholder="Ask about your agent costs..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="chat-send" id="chat-send" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>
<script>
const API_BASE = window.location.origin;

async function loadDashboard() {
  try {
    const [overviewRes, hiddenRes, timelineRes] = await Promise.all([
      fetch(API_BASE + '/api/overview').then(r => r.json()).catch(() => null),
      fetch(API_BASE + '/api/hidden-costs').then(r => r.json()).catch(() => null),
      fetch(API_BASE + '/api/timeline').then(r => r.json()).catch(() => null),
    ]);
    if (overviewRes && !overviewRes.error) renderOverview(overviewRes);
    if (hiddenRes && !hiddenRes.error) renderHiddenCosts(hiddenRes);
    if (timelineRes && !timelineRes.error) renderTimeline(timelineRes);
    if (!overviewRes || overviewRes.error) loadDemoData();
  } catch (e) { console.error('Dashboard load error:', e); loadDemoData(); }
}
function loadDemoData() {
  var overview = {agents:[{agent:"main (WhatsApp)",model:"claude-sonnet-4-5",total_tokens:892400,sessions:12,estimated_cost_usd:18.47}],total_estimated_cost_usd:18.47};
  var hidden = {cost_breakdown:{heartbeats:{count:18,tokens:77310,cost_usd:0.2484,description:"Health checks"},memory_resyncs:{count:2,tokens:50400,cost_usd:0.1784,description:"Memory reloads"},user_requests:{count:1,tokens:5920,cost_usd:0.0198,description:"Your requests"},responses:{count:1,tokens:11000,cost_usd:0.065,description:"Bot responses"}},summary:{total_cost_today:0.8926,user_initiated_cost:0.0848,hidden_cost:0.8078,waste_percentage:90.5,projected_monthly_total:27,projected_monthly_hidden:24},recommendations:[{issue:"Heartbeat overhead",monthly_waste:7.45,fix:"Increase interval to 300s",savings_pct:80},{issue:"Full memory resyncs",monthly_waste:5.35,fix:"Cache SOUL.md locally",savings_pct:60},{issue:"Context compaction with Sonnet",monthly_waste:6.84,fix:"Use Haiku for compaction",savings_pct:70}],total_potential_monthly_savings:18};
  var timeline = {timeline:[{timestamp:1739059260000,category:"heartbeat",cost_usd:0.015,tokens:4580,cumulative_cost_usd:0.015},{timestamp:1739059800000,category:"memory_resync",cost_usd:0.089,tokens:25200,cumulative_cost_usd:0.19},{timestamp:1739060460000,category:"compaction",cost_usd:0.228,tokens:56800,cumulative_cost_usd:0.6},{timestamp:1739160660000,category:"user_request",cost_usd:0.02,tokens:5920,cumulative_cost_usd:0.68},{timestamp:1739160720000,category:"response",cost_usd:0.065,tokens:11000,cumulative_cost_usd:0.75}]};
  renderOverview(overview); renderHiddenCosts(hidden); renderTimeline(timeline);
}
function renderOverview(data) {
  document.getElementById('total-cost').textContent = '$' + data.total_estimated_cost_usd.toFixed(2);
  var tbody = document.getElementById('agent-tbody');
  tbody.innerHTML = data.agents.map(function(a) {
    return '<tr><td style="font-weight:600">' + a.agent + '</td><td><span class="model-badge">' + a.model + '</span></td><td class="mono">' + (a.total_tokens/1000).toFixed(0) + 'K</td><td class="mono">' + a.sessions + '</td><td class="mono" style="color:var(--warning)">$' + a.estimated_cost_usd.toFixed(2) + '</td></tr>';
  }).join('');
}
function renderHiddenCosts(data) {
  var s = data.summary;
  document.getElementById('hidden-cost').textContent = '$' + s.hidden_cost.toFixed(2);
  document.getElementById('waste-pct').textContent = s.waste_percentage + '% of total';
  document.getElementById('monthly-cost').textContent = '$' + s.projected_monthly_total.toFixed(2);
  document.getElementById('savings').textContent = '$' + data.total_potential_monthly_savings.toFixed(2);
  var breakdown = data.cost_breakdown;
  var maxCost = Math.max.apply(null, Object.keys(breakdown).map(function(k){return breakdown[k].cost_usd;}));
  var labels = {heartbeat:'Heartbeats',heartbeats:'Heartbeats',memory_resync:'Memory Resyncs',memory_resyncs:'Memory Resyncs',whatsapp_reconnect:'WA Reconnects',whatsapp_reconnects:'WA Reconnects',email_check:'Email Scans',email_checks:'Email Scans',compaction:'Compactions',compactions:'Compactions',cost_report:'Cost Reports',cost_reports:'Cost Reports',user_request:'Your Requests',user_requests:'Your Requests',response:'Bot Responses',responses:'Bot Responses',other:'Other'};
  document.getElementById('cost-bars').innerHTML = Object.keys(breakdown).filter(function(k){return breakdown[k].cost_usd > 0;}).sort(function(a,b){return breakdown[b].cost_usd - breakdown[a].cost_usd;}).map(function(k) {
    var v = breakdown[k]; var pct = (v.cost_usd / maxCost) * 100;
    var cls = (['user_request','user_requests','response','responses'].indexOf(k)>=0) ? 'useful' : (['heartbeat','heartbeats','whatsapp_reconnect','whatsapp_reconnects','cost_report','cost_reports'].indexOf(k)>=0) ? 'waste' : 'warning';
    var colorVar = cls==='waste'?'danger':cls==='useful'?'accent':'warning';
    return '<div class="cost-bar-item"><div class="cost-bar-label">' + (labels[k]||k) + '</div><div class="cost-bar-track"><div class="cost-bar-fill '+cls+'" style="width:'+pct+'%"></div></div><div class="cost-bar-value" style="color:var(--'+colorVar+')">$'+v.cost_usd.toFixed(3)+'</div></div>';
  }).join('');
  document.getElementById('recommendations').innerHTML = data.recommendations.map(function(r) {
    return '<div class="rec-card"><div class="rec-issue">' + r.issue + '</div><div class="rec-fix">' + r.fix + '</div><div class="rec-savings">Wasting $' + r.monthly_waste.toFixed(2) + '/mo - can save ' + r.savings_pct + '%</div></div>';
  }).join('');
}
function renderTimeline(data) {
  var catLabels = {heartbeat:'Heartbeat',memory_resync:'Memory Resync',user_request:'User Request',response:'Response',compaction:'Compaction',whatsapp_reconnect:'WA Reconnect',email_check:'Email Check',cost_report:'Cost Report',other:'Other'};
  document.getElementById('timeline').innerHTML = data.timeline.map(function(t) {
    var time = new Date(t.timestamp * 1000).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return '<div class="timeline-row"><div class="timeline-time">'+time+'</div><div><span class="timeline-dot '+t.category+'"></span>'+(catLabels[t.category]||t.category)+' <span style="color:var(--text-dim);font-size:11px;margin-left:6px">'+(t.tokens/1000).toFixed(1)+'K tok</span></div><div class="timeline-cost">$'+t.cumulative_cost_usd.toFixed(3)+'</div></div>';
  }).join('');
}
async function sendMessage(text) {
  var input = document.getElementById('chat-input');
  var message = text || input.value.trim();
  if (!message) return;
  input.value = '';
  addMessage('user', message);
  var sendBtn = document.getElementById('chat-send');
  sendBtn.disabled = true;
  addMessage('system', 'Thinking...');
  try {
    var res = await fetch(API_BASE + '/api/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:message})});
    var data = await res.json();
    var msgs = document.getElementById('chat-messages');
    var lastMsg = msgs.lastElementChild;
    if (lastMsg && lastMsg.classList.contains('system')) lastMsg.remove();
    addMessage('assistant', data.response || data.error || 'No response');
  } catch (e) {
    var msgs = document.getElementById('chat-messages');
    var lastMsg = msgs.lastElementChild;
    if (lastMsg && lastMsg.classList.contains('system')) lastMsg.remove();
    addMessage('assistant', 'Budget Agent is running in analysis mode. Try: Show me my hidden costs');
  }
  sendBtn.disabled = false;
}
function addMessage(role, text) {
  var msgs = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'msg ' + role;
  var html = text.replace(/\n/g, '<br>').replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  div.innerHTML = html;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}
loadDashboard();
</script>
</body>
</html>