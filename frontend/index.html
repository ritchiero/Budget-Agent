<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Agent - AI Agent Cost Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface-2: #1a1a26;
  --border: #2a2a3a;
  --text: #e4e4ef;
  --text-dim: #8888a0;
  --accent: #00ff88;
  --accent-dim: #00cc6a;
  --danger: #ff4466;
  --danger-dim: #cc3355;
  --warning: #ffaa22;
  --info: #44aaff;
  --purple: #aa66ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  background-image: radial-gradient(ellipse at 20% 0%, rgba(255,68,102,0.04) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 100%, rgba(0,255,136,0.03) 0%, transparent 50%);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 32px; border-bottom: 1px solid var(--border); background: var(--surface);
}
.header h1 { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; color: var(--accent); letter-spacing: -0.5px; }
.header h1 span { color: var(--text-dim); font-weight: 400; }
.header-badge { display: flex; align-items: center; gap: 10px; }
.header-badge .powered-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
.header-badge .tech-badge { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 6px; display: inline-flex; align-items: center; gap: 8px; }
.tech-badge img { height: 16px; width: auto; }
.tech-badge.strands { background: rgba(0,255,136,0.12); color: #00ff88; border: 1px solid rgba(0,255,136,0.3); }
.tech-badge.bedrock { background: rgba(255,153,0,0.12); color: #ff9900; border: 1px solid rgba(255,153,0,0.3); }
.tech-badge.bedrock img { height: 20px; }
.tech-badge.datadog { background: rgba(99,68,150,0.15); color: #b794f4; border: 1px solid rgba(99,68,150,0.3); }
.tech-badge.datadog img { height: 14px; }
.main { display: grid; grid-template-columns: 1fr 400px; grid-template-rows: auto auto 1fr; gap: 0; height: calc(100vh - 65px); }
.stats-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
.stat-card { background: var(--surface); padding: 20px 24px; display: flex; flex-direction: column; gap: 6px; position: relative; }
.stat-card.glow-danger { background: linear-gradient(135deg, var(--surface) 0%, rgba(255,68,102,0.08) 100%); border-left: 3px solid var(--danger); }
.stat-card.glow-accent { background: linear-gradient(135deg, var(--surface) 0%, rgba(0,255,136,0.06) 100%); border-left: 3px solid var(--accent); }
.stat-card.glow-warning { background: linear-gradient(135deg, var(--surface) 0%, rgba(255,170,34,0.06) 100%); }
.stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.stat-value { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--text); }
.stat-value.danger { color: var(--danger); text-shadow: 0 0 20px rgba(255,68,102,0.3); }
.stat-value.accent { color: var(--accent); text-shadow: 0 0 20px rgba(0,255,136,0.3); }
.stat-value.warning { color: var(--warning); text-shadow: 0 0 20px rgba(255,170,34,0.3); }
.stat-sub { font-size: 12px; color: var(--text-dim); }
.waste-badge { display: inline-block; background: rgba(255,68,102,0.15); color: var(--danger); font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; animation: pulse-danger 2s ease-in-out infinite; }
@keyframes pulse-danger { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
.dashboard { grid-column: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
.panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; flex-shrink: 0; }
.panel-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
.panel-title { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text); }
.panel-body { padding: 20px; }
.cost-bar-group { display: flex; flex-direction: column; gap: 14px; }
.cost-bar-item { display: grid; grid-template-columns: 160px 1fr 80px; align-items: center; gap: 12px; }
.cost-bar-label { font-size: 13px; color: var(--text); font-weight: 500; }
.cost-bar-track { height: 24px; background: var(--surface-2); border-radius: 4px; overflow: hidden; position: relative; }
.cost-bar-fill { height: 100%; border-radius: 4px; transition: width 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: relative; }
.cost-bar-fill.waste { background: linear-gradient(90deg, var(--danger), var(--danger-dim)); box-shadow: 0 0 12px rgba(255,68,102,0.3); }
.cost-bar-fill.useful { background: linear-gradient(90deg, var(--accent), var(--accent-dim)); box-shadow: 0 0 12px rgba(0,255,136,0.2); }
.cost-bar-fill.warning { background: linear-gradient(90deg, var(--warning), #cc8800); box-shadow: 0 0 12px rgba(255,170,34,0.2); }
.cost-bar-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-align: right; }
.agent-table { width: 100%; border-collapse: collapse; }
.agent-table th { text-align: left; font-family: 'JetBrains Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); padding: 8px 12px; border-bottom: 1px solid var(--border); }
.agent-table td { padding: 12px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.03); }
.agent-table td.mono { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
.model-badge { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--surface-2); color: var(--purple); border: 1px solid rgba(170,102,255,0.2); }
.rec-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--danger); }
.rec-card:last-child { margin-bottom: 0; }
.rec-issue { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: var(--danger); }
.rec-fix { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 8px; }
.rec-savings { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); font-weight: 600; }
.chat-panel { grid-column: 2; grid-row: 2 / -1; border-left: 1px solid var(--border); display: flex; flex-direction: column; background: var(--surface); }
.chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
.chat-header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.msg { max-width: 95%; padding: 12px 16px; border-radius: 8px; font-size: 13px; line-height: 1.6; }
.msg.assistant { background: var(--surface-2); border: 1px solid var(--border); align-self: flex-start; }
.msg.user { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.2); align-self: flex-end; color: var(--accent); }
.msg.system { background: transparent; color: var(--text-dim); font-size: 12px; text-align: center; align-self: center; font-style: italic; }
.msg pre { font-family: 'JetBrains Mono', monospace; font-size: 12px; background: var(--bg); padding: 10px; border-radius: 4px; margin-top: 8px; overflow-x: auto; white-space: pre-wrap; }
.chat-input-area { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
.chat-input { flex: 1; background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 13px; outline: none; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-dim); }
.chat-send { background: var(--accent); border: none; border-radius: 6px; padding: 10px 16px; color: var(--bg); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; font-family: 'JetBrains Mono', monospace; }
.chat-send:hover { background: var(--accent-dim); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
.quick-actions { padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 6px; border-bottom: 1px solid var(--border); }
.quick-btn { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 5px 10px; border-radius: 4px; background: var(--surface-2); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
.quick-btn:hover { border-color: var(--accent); color: var(--accent); }
.timeline-row { display: grid; grid-template-columns: 80px 1fr 60px; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 12px; }
.timeline-time { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 11px; }
.timeline-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.timeline-dot.heartbeat { background: var(--danger); }
.timeline-dot.memory_resync { background: var(--warning); }
.timeline-dot.user_request { background: var(--accent); }
.timeline-dot.response { background: var(--info); }
.timeline-dot.compaction { background: var(--purple); }
.timeline-dot.whatsapp_reconnect { background: #ff6644; }
.timeline-dot.email_check { background: #44ccff; }
.timeline-dot.cost_report { background: #ffcc44; }
.timeline-dot.cron_task { background: #aa88ff; }
.timeline-dot.other { background: var(--text-dim); }
.timeline-cost { font-family: 'JetBrains Mono', monospace; text-align: right; font-size: 11px; color: var(--text-dim); }
.loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-dim); font-size: 13px; }
.spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
@keyframes spin { to { transform: rotate(360deg); } }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
@media (max-width: 900px) { .main { grid-template-columns: 1fr; } .chat-panel { grid-column: 1; grid-row: auto; height: 400px; } .stats-row { grid-template-columns: repeat(2, 1fr); } }
</style>
</head>
<body>
<div class="header">
  <h1>&#x1f50d; budget-agent <span>/ &#x1f99e; clawdbot</span></h1>
  <div class="header-badge">
    <span class="powered-label">Powered by</span>
    <span class="tech-badge strands">&#x1f9ec; Strands SDK</span>
    <span class="tech-badge bedrock"><img src="https://cms.article-factory.ai/wp-content/uploads/2023/04/amazon-bedrock.png" alt="Bedrock"> Bedrock</span>
    <span class="tech-badge datadog"><img src="https://companieslogo.com/img/orig/DDOG_BIG.D-4363d6d1.png?t=1720244491" alt="Datadog"> LLM Observability</span>
  </div>
</div>
<div class="main">
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Total Spent</div>
      <div class="stat-value" id="total-cost">&mdash;</div>
      <div class="stat-sub">across all agents</div>
    </div>
    <div class="stat-card glow-danger">
      <div class="stat-label">&#x1f6a8; Hidden Costs</div>
      <div class="stat-value danger" id="hidden-cost">&mdash;</div>
      <div class="stat-sub"><span class="waste-badge" id="waste-pct">&mdash;</span> of total is waste</div>
    </div>
    <div class="stat-card glow-warning">
      <div class="stat-label">Monthly Projection</div>
      <div class="stat-value warning" id="monthly-cost">&mdash;</div>
      <div class="stat-sub">at current rate</div>
    </div>
    <div class="stat-card glow-accent">
      <div class="stat-label">&#x1f4b0; Potential Savings</div>
      <div class="stat-value accent" id="savings">&mdash;</div>
      <div class="stat-sub">per month with fixes</div>
    </div>
  </div>
  <div class="dashboard">
    <div class="panel"><div class="panel-header"><div class="panel-title">&#x1f6a8; Hidden Cost Breakdown</div></div>
      <div class="panel-body"><div class="cost-bar-group" id="cost-bars"><div class="loading"><div class="spinner"></div>Analyzing costs...</div></div></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">&#x1f916; Active Agents</div></div>
      <div class="panel-body" style="padding:0"><table class="agent-table"><thead><tr><th>Agent</th><th>Model</th><th>Tokens</th><th>Sessions</th><th>Cost</th></tr></thead><tbody id="agent-tbody"><tr><td colspan="5"><div class="loading"><div class="spinner"></div>Loading agents...</div></td></tr></tbody></table></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">&#x1f4a1; Optimization Recommendations</div></div>
      <div class="panel-body" id="recommendations"><div class="loading"><div class="spinner"></div>Generating recommendations...</div></div></div>
    <div class="panel"><div class="panel-header"><div class="panel-title">&#x1f4c8; Cost Timeline</div></div>
      <div class="panel-body" id="timeline"><div class="loading"><div class="spinner"></div>Loading timeline...</div></div></div>
  </div>
  <div class="chat-panel">
    <div class="chat-header"><div class="dot"></div>Ask the Auditor<span style="font-size:10px;color:var(--text-dim);margin-left:auto;font-weight:400">via Strands Agent</span></div>
    <div class="quick-actions">
      <button class="quick-btn" onclick="sendMessage('Show me my hidden costs')">Hidden costs</button>
      <button class="quick-btn" onclick="sendMessage('How much would it cost to research competitors?')">Estimate task</button>
      <button class="quick-btn" onclick="sendMessage('Which agent wastes the most?')">Worst agent</button>
      <button class="quick-btn" onclick="sendMessage('How can I save money?')">Save money</button>
    </div>
    <div class="chat-messages" id="chat-messages"><div class="msg system">&#x1f99e; Budget Agent connected &mdash; analyzing your real Clawdbot data. Ask me anything about your AI spending.</div></div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chat-input" placeholder="Ask about your agent costs..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="chat-send" id="chat-send" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>
<script>
const API_BASE = window.location.origin;
async function loadDashboard() {
  try {
    const [overviewRes, hiddenRes, timelineRes] = await Promise.all([
      fetch(`${API_BASE}/api/overview`).then(r => r.json()).catch(() => null),
      fetch(`${API_BASE}/api/hidden-costs`).then(r => r.json()).catch(() => null),
      fetch(`${API_BASE}/api/timeline`).then(r => r.json()).catch(() => null),
    ]);
    if (overviewRes) renderOverview(overviewRes);
    if (hiddenRes) renderHiddenCosts(hiddenRes);
    if (timelineRes) renderTimeline(timelineRes);
  } catch (e) { console.error('Dashboard load error:', e); }
}
function renderOverview(data) {
  document.getElementById('total-cost').textContent = `$${data.total_estimated_cost_usd.toFixed(2)}`;
  const tbody = document.getElementById('agent-tbody');
  tbody.innerHTML = data.agents.map((a, i) => {
    let name = a.agent;
    if (name.includes('-') && name.length > 20) name = `Session ${i + 1}`;
    const modelLabel = a.model === 'unknown' ? 'unknown' : a.model.replace('claude-', '').replace('-20250514','');
    return `<tr><td style="font-weight:600">${name}</td><td><span class="model-badge">${modelLabel}</span></td><td class="mono">${(a.total_tokens/1000).toFixed(0)}K</td><td class="mono">${a.sessions}</td><td class="mono" style="color:var(--warning)">$${a.estimated_cost_usd.toFixed(2)}</td></tr>`;
  }).join('');
}
function renderHiddenCosts(data) {
  const s = data.summary;
  document.getElementById('hidden-cost').textContent = `$${s.hidden_cost.toFixed(2)}`;
  document.getElementById('waste-pct').textContent = `${s.waste_percentage}%`;
  let monthlyTotal = s.projected_monthly_total;
  let monthlySavings = data.total_potential_monthly_savings;
  if (monthlyTotal < s.total_cost_today) {
    const activeDays = 12;
    monthlyTotal = (s.total_cost_today / activeDays) * 30;
    monthlySavings = (s.hidden_cost / activeDays * 30) * 0.75;
  }
  document.getElementById('monthly-cost').textContent = `$${monthlyTotal.toFixed(0)}`;
  document.getElementById('savings').textContent = `$${monthlySavings.toFixed(0)}`;
  const breakdown = data.cost_breakdown;
  const maxCost = Math.max(...Object.values(breakdown).map(v => v.cost_usd));
  const labels = {
    heartbeat: '\u{1F493} Heartbeats', memory_resync: '\u{1F9E0} Memory Resyncs',
    whatsapp_reconnect: '\u{1F4F1} WA Reconnects', email_check: '\u{1F4E7} Email Scans',
    compaction: '\u{1F4E6} Compactions', cost_report: '\u{1F4CA} Cost Reports',
    cron_task: '\u23F0 Cron Tasks', user_request: '\u{1F464} Your Requests',
    response: '\u{1F916} Bot Responses', other: '\u2753 Other'
  };
  document.getElementById('cost-bars').innerHTML = Object.keys(breakdown)
    .filter(k => breakdown[k].cost_usd > 0)
    .sort((a, b) => breakdown[b].cost_usd - breakdown[a].cost_usd)
    .map(k => {
      const v = breakdown[k]; const pct = (v.cost_usd / maxCost) * 100;
      const cls = ['user_request','response'].includes(k) ? 'useful' : ['heartbeat','whatsapp_reconnect','cost_report'].includes(k) ? 'waste' : 'warning';
      return `<div class="cost-bar-item"><div class="cost-bar-label">${labels[k]||k}</div><div class="cost-bar-track"><div class="cost-bar-fill ${cls}" style="width:${pct}%"></div></div><div class="cost-bar-value" style="color:var(--${cls==='waste'?'danger':cls==='useful'?'accent':'warning'})">$${v.cost_usd.toFixed(3)}</div></div>`;
    }).join('');
  const activeDaysFix = (s.projected_monthly_total < s.total_cost_today) ? 12 : null;
  document.getElementById('recommendations').innerHTML = data.recommendations.map(r => {
    let waste = r.monthly_waste;
    if (activeDaysFix) { const ck = Object.keys(breakdown).find(k => r.issue.toLowerCase().includes(k.replace('_',' '))); if (ck) waste = (breakdown[ck].cost_usd/activeDaysFix)*30; }
    return `<div class="rec-card"><div class="rec-issue">\u26A0\uFE0F ${r.issue}</div><div class="rec-fix">${r.fix}</div><div class="rec-savings">\u{1F4B0} Wasting $${waste.toFixed(2)}/mo \u2014 can save ${r.savings_pct}%</div></div>`;
  }).join('');
}
function renderTimeline(data) {
  const cl = { heartbeat:'Heartbeat', memory_resync:'Memory Resync', user_request:'User Request', response:'Response', compaction:'Compaction', whatsapp_reconnect:'WhatsApp Reconnect', email_check:'Email Check', cost_report:'Cost Report', cron_task:'Cron Task', other:'Other' };
  document.getElementById('timeline').innerHTML = data.timeline.map(t => {
    let ts = t.timestamp; if (ts && ts < 1e12) ts *= 1000;
    const time = ts ? new Date(ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})+' '+new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '\u2014';
    return `<div class="timeline-row"><div class="timeline-time">${time}</div><div><span class="timeline-dot ${t.category}"></span>${cl[t.category]||t.category} <span style="color:var(--text-dim);font-size:11px;margin-left:6px">${(t.tokens/1000).toFixed(1)}K tok</span></div><div class="timeline-cost">$${t.cumulative_cost_usd.toFixed(3)}</div></div>`;
  }).join('');
}
async function sendMessage(text) {
  const input = document.getElementById('chat-input');
  const message = text || input.value.trim();
  if (!message) return;
  input.value = '';
  addMessage('user', message);
  const sendBtn = document.getElementById('chat-send');
  sendBtn.disabled = true;
  addMessage('system', '\u23F3 Thinking...');
  try {
    const res = await fetch(`${API_BASE}/api/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message}) });
    const data = await res.json();
    const msgs = document.getElementById('chat-messages');
    const last = msgs.lastElementChild;
    if (last && last.classList.contains('system')) last.remove();
    addMessage('assistant', data.response || data.error || 'No response');
  } catch(e) {
    const msgs = document.getElementById('chat-messages');
    const last = msgs.lastElementChild;
    if (last && last.classList.contains('system')) last.remove();
    addMessage('assistant', '\u{1F50D} Budget Agent is running in analysis mode.');
  }
  sendBtn.disabled = false;
}
function addMessage(role, text) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = text.replace(/`([^`]+)`/g,'<code style="background:var(--bg);padding:2px 6px;border-radius:3px;font-family:JetBrains Mono,monospace;font-size:12px">$1</code>').replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}
loadDashboard();
</script>
</body>
</html>